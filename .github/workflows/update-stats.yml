# ============================================================================
# GitHub Actions Workflow - Mise Ã  Jour Automatique des Stats
# ============================================================================
#
# Ce workflow met Ã  jour automatiquement votre profil GitHub avec vos
# statistiques les plus rÃ©centes, incluant les dÃ©pÃ´ts privÃ©s.
#
# DÃ©clencheurs:
# - Tous les jours Ã  00:00 UTC (schedule)
# - Manuel via l'interface GitHub (workflow_dispatch)
# - Push sur la branche main (optionnel)
#
# ============================================================================
name: ğŸ“Š Update GitHub Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      clear_cache:
        description: 'Nettoyer le cache avant exÃ©cution'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Mode dry-run (ne pas publier sur GitHub)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  update-stats:
    name: ğŸ”„ Mettre Ã  jour les statistiques
    runs-on: ubuntu-latest

    steps:
      # 0. Checkout du repository (doit Ãªtre fait avant d'exÃ©cuter des commandes git)
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 1. S'assurer d'Ãªtre sur la branche main Ã  jour
      - name: ğŸ”€ Sync with main
        run: |
          git fetch --prune origin
          git checkout main || git checkout -b main
          git reset --hard origin/main

      # 2. Configuration de Python
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.1'

      # 3. Installer les dÃ©pendances
      - name: ğŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      # 4. Afficher les informations de l'environnement
      - name: â„¹ï¸ Display environment info
        run: |
          echo "ğŸ” Informations de l'environnement:"
          echo "   Python: $(python --version)"
          echo "   Utilisateur: ${{ github.repository_owner }}"
          echo "   Repository: ${{ github.repository }}"
          echo "   Workflow: ${{ github.workflow }}"
          echo "   Run ID: ${{ github.run_id }}"
          echo ""
          echo "ğŸ• Temps d'exÃ©cution: $(date)"

      # 5. Nettoyer le cache (si demandÃ©)
      - name: ğŸ§¹ Clear cache
        if: github.event.inputs.clear_cache == 'true'
        run: |
          echo "ğŸ§¹ Nettoyage du cache..."
          rm -rf .cache/
          echo "âœ… Cache nettoyÃ©"

      # 6. ExÃ©cuter le script de mise Ã  jour
      - name: ğŸš€ Run update script
        env:
          GITHUB_TOKEN: ${{ secrets.STATS_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
          CACHE_ENABLED: 'true'
          LOG_LEVEL: 'INFO'
        run: |
          echo "ğŸš€ DÃ©marrage de la mise Ã  jour des statistiques..."
          OPTIONS=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            OPTIONS="$OPTIONS --dry-run"
            echo "â„¹ï¸ Mode dry-run activÃ©"
          fi
          python scripts/update_stats.py $OPTIONS
          echo "âœ… Script terminÃ© avec succÃ¨s"

      # 7. VÃ©rifier les changements
      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dÃ©tectÃ© dans le README"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changements dÃ©tectÃ©s dans le README"
            echo ""
            echo "ğŸ“Š Statistiques des changements:"
            git diff --stat README.md
          fi

      # 8. Commit et push (si changements et pas en dry-run)
      - name: ğŸ’¾ Commit and push changes
        if: |
          steps.check_changes.outputs.changed == 'true' &&
          github.event.inputs.dry_run != 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "ğŸ¤– Auto-update GitHub stats - $(date +'%Y-%m-%d %H:%M')" \
                     -m "Updated by GitHub Actions workflow" \
                     -m "Run ID: ${{ github.run_id }}" \
                     -m "Triggered by: ${{ github.event_name }}"
          git push origin HEAD:main || git push origin HEAD:master || {
            echo "âŒ Erreur lors du push"
            echo "VÃ©rifiez que le workflow a les permissions d'Ã©criture"
            exit 1
          }
          echo "âœ… Changements commitÃ©es et poussÃ©s avec succÃ¨s"

      # 9. RÃ©sumÃ© de l'exÃ©cution
      - name: ğŸ“‹ Execution summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo "           ğŸ“Š RÃ‰SUMÃ‰ DE L'EXÃ‰CUTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo ""
          echo "âœ… Statut: ${{ job.status }}"
          echo "ğŸ• TerminÃ© Ã : $(date)"
          echo "ğŸ”— Profil: https://github.com/${{ github.repository_owner }}"
          echo ""
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "ğŸ“ README mis Ã  jour avec succÃ¨s!"
          else
            echo "â„¹ï¸ Aucune mise Ã  jour nÃ©cessaire"
          fi
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="

      # 10. Gestion des erreurs
      - name: âŒ Handle errors
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo "           âŒ ERREUR LORS DE L'EXÃ‰CUTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo ""
          echo "Une erreur s'est produite lors de l'exÃ©cution du workflow."
          echo ""
          echo "ğŸ” Actions de dÃ©pannage:"
          echo "   1. VÃ©rifiez que GITHUB_TOKEN ou STATS_TOKEN est configurÃ©"
          echo "   2. VÃ©rifiez les permissions du token (repo, user)"
          echo "   3. Consultez les logs ci-dessus pour plus de dÃ©tails"
          echo ""
          echo "ğŸ“š Documentation: https://docs.github.com/actions"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          exit 1