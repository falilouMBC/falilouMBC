# ============================================================================
# GitHub Actions Workflow - Mise Ã  Jour Automatique des Stats
# ============================================================================
#
# Ce workflow met Ã  jour automatiquement votre profil GitHub avec vos
# statistiques les plus rÃ©centes, incluant les dÃ©pÃ´ts privÃ©s.
#
# DÃ©clencheurs:
# - Tous les jours Ã  00:00 UTC (schedule)
# - Manuel via l'interface GitHub (workflow_dispatch)
# - Push sur la branche main (optionnel)
#
# ============================================================================
name: ğŸ“Š Update GitHub Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      clear_cache:
        description: 'Nettoyer le cache avant exÃ©cution'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Mode dry-run (ne pas publier sur GitHub)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  update-stats:
    name: ğŸ”„ Mettre Ã  jour les statistiques
    runs-on: ubuntu-latest
    concurrency:
      group: update-stats
      cancel-in-progress: false

    steps:
      # -----------------------------------------------------------------------
      # 0. Checkout du repository (doit Ãªtre fait avant d'exÃ©cuter des commandes git)
      # -----------------------------------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # RÃ©cupÃ©rer tout l'historique
          token: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # 1. S'assurer d'Ãªtre sur la branche main Ã  jour
      # -----------------------------------------------------------------------
      - name: ğŸ”€ Sync with main
        run: |
          # RÃ©cupÃ©rer les rÃ©fÃ©rences et nettoyer les branches supprimÃ©es
          git fetch --prune origin

          # Assurer que la branche main existe localement
          git checkout main || git checkout -b main

          # Aligner la branche locale sur origin/main pour Ã©viter les conflits lors du push
          git reset --hard origin/main

      # -----------------------------------------------------------------------
      # 2. Configuration de Python
      # -----------------------------------------------------------------------
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.1'

      # -----------------------------------------------------------------------
      # 3. Installer les dÃ©pendances
      # -----------------------------------------------------------------------
      - name: ğŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      # -----------------------------------------------------------------------
      # 4. Afficher les informations de l'environnement
      # -----------------------------------------------------------------------
      - name: â„¹ï¸ Display environment info
        run: |
          echo "ğŸ” Informations de l'environnement:"
          echo "   Python: $(python --version)"
          echo "   Utilisateur: ${{ github.repository_owner }}"
          echo "   Repository: ${{ github.repository }}"
          echo "   Workflow: ${{ github.workflow }}"
          echo "   Run ID: ${{ github.run_id }}"
          echo ""
          echo "ğŸ• Temps d'exÃ©cution: $(date)"

      # -----------------------------------------------------------------------
      # 5. Nettoyer le cache (si demandÃ©)
      # -----------------------------------------------------------------------
      - name: ğŸ§¹ Clear cache
        if: github.event.inputs.clear_cache == 'true'
        run: |
          echo "ğŸ§¹ Nettoyage du cache..."
          rm -rf .cache/
          echo "âœ… Cache nettoyÃ©"

      # -----------------------------------------------------------------------
      # 6. ExÃ©cuter le script de mise Ã  jour
      # -----------------------------------------------------------------------
      - name: ğŸš€ Run update script
        env:
          # IMPORTANT: Utilisez un Personal Access Token avec les permissions appropriÃ©es
          # CrÃ©ez un secret nommÃ© STATS_TOKEN dans les settings de votre repo si besoin
          # Si STATS_TOKEN n'existe pas, on utilisera GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.STATS_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
          CACHE_ENABLED: 'true'
          LOG_LEVEL: 'INFO'
        run: |
          echo "ğŸš€ DÃ©marrage de la mise Ã  jour des statistiques..."

          # Construire les options
          OPTIONS=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            OPTIONS="$OPTIONS --dry-run"
            echo "â„¹ï¸ Mode dry-run activÃ©"
          fi

          # ExÃ©cuter le script
          python scripts/update_stats.py $OPTIONS

          echo "âœ… Script terminÃ© avec succÃ¨s"

      # -----------------------------------------------------------------------
      # 7. VÃ©rifier les changements
      # -----------------------------------------------------------------------
      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          # VÃ©rifier si le README a Ã©tÃ© modifiÃ©
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dÃ©tectÃ© dans le README"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changements dÃ©tectÃ©s dans le README"

            # Afficher les statistiques des changements
            echo ""
            echo "ğŸ“Š Statistiques des changements:"
            git diff --stat README.md
          fi

      # -----------------------------------------------------------------------
      # 8. Commit et push (si changements et pas en dry-run)
      #     â€” rÃ©essaie proprement et sÃ©curisÃ© en cas de non-fast-forward
      # -----------------------------------------------------------------------
      - name: ğŸ’¾ Commit and push changes
        if: |
          steps.check_changes.outputs.changed == 'true' &&
          github.event.inputs.dry_run != 'true'
        run: |
          set -euo pipefail

          # Config Git
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          # PrÃ©parer le commit (README seulement; stats est ignorÃ© par .gitignore)
          git add README.md || true

          # Si aucun changement Ã  committer (sÃ©curitÃ©)
          if git diff --cached --quiet; then
            echo "â„¹ï¸ Aucun changement Ã  commiter aprÃ¨s staging, sortie."
            exit 0
          fi

          git commit -m "ğŸ¤– Auto-update GitHub stats - $(date +'%Y-%m-%d %H:%M')" \
                     -m "Updated by GitHub Actions workflow" \
                     -m "Run ID: ${{ github.run_id }}" \
                     -m "Triggered by: ${{ github.event_name }}"

          # S'assurer que nous avons les derniers commits distants
          git fetch origin main

          # Rebaser notre commit sur origin/main pour Ã©viter les non-fast-forward
          # Si rebase Ã©choue (conflit), on affichera l'erreur et on Ã©chouera pour laisser intervention manuelle.
          if ! git rebase origin/main; then
            echo "âŒ Conflit lors du rebase sur origin/main. Intervenir manuellement."
            git rebase --abort || true
            exit 1
          fi

          # Essayer un push normal d'abord
          if git push origin HEAD:main; then
            echo "âœ… Push effectuÃ© avec succÃ¨s."
          else
            # Si push rejetÃ© (concurrence), tenter un push --force-with-lease (plus sÃ»r que --force)
            echo "âš ï¸ Push rejetÃ©, tentative de push --force-with-lease..."
            if git push --force-with-lease origin HEAD:main; then
              echo "âœ… Push forcÃ© (with-lease) effectuÃ©."
            else
              echo "âŒ Ã‰chec du push mÃªme avec --force-with-lease."
              exit 1
            fi
          fi

      # -----------------------------------------------------------------------
      # 9. RÃ©sumÃ© de l'exÃ©cution
      # -----------------------------------------------------------------------
      - name: ğŸ“‹ Execution summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo "           ğŸ“Š RÃ‰SUMÃ‰ DE L'EXÃ‰CUTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo ""
          echo "âœ… Statut: ${{ job.status }}"
          echo "ğŸ• TerminÃ© Ã : $(date)"
          echo "ğŸ”— Profil: https://github.com/${{ github.repository_owner }}"
          echo ""

          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "ğŸ“ README mis Ã  jour avec succÃ¨s!"
          else
            echo "â„¹ï¸ Aucune mise Ã  jour nÃ©cessaire"
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="

      # -----------------------------------------------------------------------
      # 10. Gestion des erreurs
      # -----------------------------------------------------------------------
      - name: âŒ Handle errors
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          echo "           âŒ ERREUR LORS DE L'EXÃ‰CUTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Une erreur s'est produite lors de l'exÃ©cution du workflow."
          echo ""
          echo "ğŸ” Actions de dÃ©pannage:"
          echo "   1. VÃ©rifiez que GITHUB_TOKEN ou STATS_TOKEN est configurÃ©"
          echo "   2. VÃ©rifiez les permissions du token (repo, user)"
          echo "   3. Consultez les logs ci-dessus pour plus de dÃ©tails"
          echo ""
          echo "ğŸ“š Documentation: https://docs.github.com/actions"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•="
          exit 1

# ============================================================================
# Configuration du Token (info)
# ============================================================================
#
# Pour que ce workflow fonctionne correctement, vous pouvez crÃ©er un
# Personal Access Token (PAT) nommÃ© STATS_TOKEN si vous avez besoin d'accÃ©der
# Ã  des dÃ©pÃ´ts privÃ©s ou d'utiliser un token distinct pour pousser depuis le job.
# Si STATS_TOKEN est fourni en secret, il sera utilisÃ© pour la variable
# d'environnement GITHUB_TOKEN lors de l'exÃ©cution du script.
#
# Remarque: actions/checkout utilisera par dÃ©faut le token passÃ© via 'token:'
# pour configurer les credentials git du runner. Si vous avez besoin que les
# pushes utilisent STATS_TOKEN (au lieu du GITHUB_TOKEN du runner), il faudra
# configurer explicitement l'URL distante avec ce token (mÃ©thode avancÃ©e).
#
# ============================================================================