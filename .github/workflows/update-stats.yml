# ============================================================================
# GitHub Actions Workflow - Mise Ã  Jour Automatique des Stats
# ============================================================================

name: ğŸ“Š Update GitHub Stats

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  
  workflow_dispatch:
    inputs:
      clear_cache:
        description: 'Nettoyer le cache avant exÃ©cution'
        required: false
        type: boolean
        default: false
      
      dry_run:
        description: 'Mode dry-run (ne pas publier sur GitHub)'
        required: false
        type: boolean
        default: false

jobs:
  update-stats:
    name: ğŸ”„ Mettre Ã  jour les statistiques
    runs-on: ubuntu-latest
    
    steps:
        - name: ğŸ“¥ Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: ğŸ”„ Sync branch
          run: |
            git fetch origin main
            git checkout main || git checkout -b main
            git pull origin main
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.1'

      - name: ğŸ“¦ Install dependencies
        run: pip install -r requirements.txt
      
      - name: â„¹ï¸ Display environment info
        run: |
          echo "ğŸ” Informations de l'environnement:"
          echo "   Python: $(python --version)"
          echo "   Utilisateur: ${{ github.repository_owner }}"
          echo "   Repository: ${{ github.repository }}"
          echo "   Workflow: ${{ github.workflow }}"
          echo "   Run ID: ${{ github.run_id }}"
          echo ""
          echo "ğŸ• Temps d'exÃ©cution: $(date)"
      
      - name: ğŸ§¹ Clear cache
        if: github.event.inputs.clear_cache == 'true'
        run: |
          echo "ğŸ§¹ Nettoyage du cache..."
          rm -rf .cache/
          echo "âœ… Cache nettoyÃ©"
      
      - name: ğŸš€ Run update script
        env:
          GITHUB_TOKEN: ${{ secrets. STATS_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
          CACHE_ENABLED: 'true'
          LOG_LEVEL: 'INFO'
        run: |
          echo "ğŸš€ DÃ©marrage de la mise Ã  jour des statistiques..."
          
          OPTIONS=""
          if [ "${{ github. event.inputs.dry_run }}" == "true" ]; then
            OPTIONS="$OPTIONS --dry-run"
            echo "â„¹ï¸ Mode dry-run activÃ©"
          fi
          
          python scripts/update_stats.py $OPTIONS
          
          echo "âœ… Script terminÃ© avec succÃ¨s"
      
      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun changement dÃ©tectÃ© dans le README"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changements dÃ©tectÃ©s dans le README"
            echo ""
            echo "ğŸ“Š Statistiques des changements:"
            git diff --stat README.md
          fi
      
        - name: âš™ï¸ Configure git
          run: |
            git config --local user.name "github-actions[bot]"
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ğŸ’¾ Commit and push changes
        if: |
          steps.check_changes.outputs.changed == 'true' && 
           github.event.inputs.dry_run != 'true'
        run: |
          git add README.md
          
          git commit -m "ğŸ¤– Auto-update GitHub stats - $(date +'%Y-%m-%d %H:%M')" \
                     -m "Updated by GitHub Actions workflow" \
                     -m "Run ID: ${{ github.run_id }}" \
                     -m "Triggered by: ${{ github.event_name }}"
          
          git push origin main
          
          echo "âœ… Changements commitÃ©es et poussÃ©s avec succÃ¨s"
      
      - name: ğŸ“‹ Execution summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           ğŸ“Š RÃ‰SUMÃ‰ DE L'EXÃ‰CUTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Statut: ${{ job.status }}"
          echo "ğŸ• TerminÃ© Ã : $(date)"
          echo "ğŸ”— Profil: https://github.com/${{ github. repository_owner }}"
          echo ""
          
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "ğŸ“ README mis Ã  jour avec succÃ¨s!"
          else
            echo "â„¹ï¸ Aucune mise Ã  jour nÃ©cessaire"
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: âŒ Handle errors
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           âŒ ERREUR LORS DE L'EXÃ‰CUTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Une erreur s'est produite lors de l'exÃ©cution du workflow."
          echo ""
          echo "ğŸ” Actions de dÃ©pannage:"
          echo "   1. VÃ©rifiez que GITHUB_TOKEN ou STATS_TOKEN est configurÃ©"
          echo "   2. VÃ©rifiez les permissions du token (repo, user)"
          echo "   3.  Consultez les logs ci-dessus pour plus de dÃ©tails"
          echo ""
          echo "ğŸ“š Documentation: https://docs.github.com/actions"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
